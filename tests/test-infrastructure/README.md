GovTool Test Infrastructure
====================

Services required for testing GovTool

## 1. Setting up the services


####  a. Deploy with docker on swarm mode.

- Create `.env` file by copying `.env.example` and update it.
- Make sure that  DNS is pointed to the right server. Following are the domains used.
  - lighthouse.BASE_DOMAIN
  - metabase.BASE_DOMAIN
  - sonarqube.BASE_DOMAIN
  - metrics.BASE_DOMAIN
  - kuber.BASE_DOMAIN


`docker stack deploy` command doesn't support `.env` file secret/config files.
There's a helper script `deploy-swarm.sh` to load the environment variables from `.env` file and generate rendered docker compose file.
```bash
cd ./test/test-infrastructire # cd into the test-infrastructure folder
docker swarm init # if swarm mode is not enabled yet. 
docker compose build # build the images
docker node update xxxx --label-add govtool-test-stack=true ## set the node to be used for deploying the services
./gen-configs.sh  # generate configs and secrets.
./deploy-swarm.sh prepare # start postgres and nginx
sleep 30 # wait for 30 secs for postgres to be healthy
./deploy-swarm.sh finalize # deploy all the required services.
```

#### b. Setup
When the stack is ready, further configuration is required it the services and github repo secrets and workflow files.

# 2. Services List

## SonarQube Server
#### Requires
- postgres database

#### Used by
- Github Action to submit sonar-sacanner result

`sonar-scanner` is used for static analysis of code.
The analysis generated by sonar-scanner is saved to SonarQube server for better visibility and to see progress over time.


**Docker Image:** [mc1arke/sonarqube-with-community-branch-plugin:9.9-community](https://hub.docker.com/layers/mc1arke/sonarqube-with-community-branch-plugin/9.9-community/images/sha256-b91ac551bea0fc3b394eaf7f82ea79115e03db9ab47d26610b9e1566723a07a5?context=explore)

**See :** [sonar-scanner](https://docs.sonarsource.com/sonarqube/latest/analyzing-source-code/scanners/sonarscanner/), [actions/sonar-scanner](https://github.com/marketplace/actions/sonar-scanner)

### Initial configuration.

- Login and change the initial password.
```
username: admin
password: admin
```
- Create new project and set the projectKey in file [govtool/frontend/sonar-project.properties](../../govtool/frontend/sonar-project.properties)
- Update the github action secrets
  - SONAR_HOST_URL
  - SONAR_TOKEN


## Metabase Server
#### Requires
- postgres database

Metabase provides UI to show graphs and visualization from different datasource. 
It is used for visualizing the test metrics and the api response times over time.

**Docker Image:** [metabase/metabase:v0.46.6.4](https://hub.docker.com/layers/metabase/metabase/v0.46.6.4/images/sha256-95c60db0c87c5da9cb81f6aefd0cd548fe2c14ff8c8dcba2ea58a338865cdbd9?context=explore)

### Initial Configuration
 - Setup initial account for ligin via the webapp.
 - Under database section in admin settings, add the `govtool_lithghouse` and `govtool_metrics` databases
 - Select the database and add visualizations, queries for the data.

## LightHouse Report Server
#### Requires
- postgres database

#### Used by
- Github Action to submit lighthouse report.

Lighthouse  has audits for performance, accessibility, progressive web apps, SEO, and more.
Lighthouse-Server is used to host and display the audits generated by lighthouse.

**Docker Image:**  [patrickhulce/lhci-server:0.12.0](https://hub.docker.com/r/patrickhulce/lhci-server)

### Initial Configuration
- install lhci locally and run `lhci wizard` to setup project
- update `--serverBaseUrl={{...}}` parameter in [.github/workflows/lighthouse.yml](../../.github/workflows/lighthouse.yml)
- update `LHCI_SERVER_TOKEN` in github secrets.
- install lighthouse github app on the repo
- obtain app token from lighthouse app and update `LHCI_GITHUB_APP_TOKEN` secret

See: **[lighthouse-server-docs](https://googlechrome.github.io/lighthouse-ci/docs/server.html)**


## Metrics API Server
#### Requires
- postgres database
- metabase *(for result visualization)


#### Used by
- Github Action - backend test to submit test metrics.

Metrics API Server receives metrics collected during backend test and saves them to database.
The results are visualized in metabase.

### Initial Configuration
- update `RECORD_METRICS_API` variable in file [.github/workflows/test_backend.yml](../../.github/workflows/test_backend.yml)


**Source Code:** [tests/test-metrics-api](../test-metrics-api)

## Kuber Server
#### Requires
- cardano-node's socket connection

#### Used by
- Cypress integration test 
- Governance Data Loader 

Opensource API server for transaction building and querying the ledger .
Kuber makes it easy to construct and submit transaction from the frontend.

**Docker Image:** [dquadrant/kuber:70be9b0166177eab5cf33e603fd3dc579e14cf31](https://hub.docker.com/layers/dquadrant/kuber/70be9b0166177eab5cf33e603fd3dc579e14cf31/images/sha256-d3b3f7c2304da8c4777155b26220238b682c81a3ff2b14753a5dc41c4f151364?context=explore)

### Initial Configuration
- update `CYPRESS_kuberApiUrl` variable in [.github/workflows/test_integration_cypress.yml](../../.github/workflows/test_integration_cypress.yml)
