version: "3.9"
secrets:
  postgres_user:
    external: true
    name:  ${STACK_NAME}_postgres_user
  postgres_password:
    external: true
    name:  ${STACK_NAME}_postgres_password
  lighthouserc.json:
    external: true
    name:  ${STACK_NAME}_lighthouserc.json
  metrics_api_secret_token:
    external: true
    name: ${STACK_NAME}_metrics_api_secret

volumes:
  lhci_data:
  node_data:
  node_ipc:
  dbsync_data:

networks:
  postgres:
    external: true
  frontend:
    external: true

services:
  metrics_api:
    image: voltaire-era/govtool-metrics-api
    build:
      context: ../test-metrics-api
    environment:
      VIRTUAL_HOST: https://metrics-${BASE_DOMAIN}/ -> :3000/
      PGHOST: postgres
      PGDATABASE: ${STACK_NAME}_metrics
    secrets:
      - source: postgres_password
        target: /run/secrets/pgpassword
      - source: postgres_user
        target: /run/secrets/pguser
      - source: metrics_api_secret_token
        target: /run/secrets/api_secret_token
    networks:
      - postgres
      - frontend
    deploy:
      placement:
        constraints:
          - node.labels.govtool-test-stack == true
      restart_policy:
        delay: "30s"
      resources:
        limits:
          memory: 600M
        reservations:
          memory: 100M

  lhci-server:
    image: patrickhulce/lhci-server:0.12.0
    environment:
      VIRTUAL_HOST: https://lighthouse-${BASE_DOMAIN} -> :9001
    volumes:
      - lhci_data:/data
    secrets:
      - source: lighthouserc.json
        target: /usr/src/lhci/lighthouserc.json
    networks:
      - postgres
      - frontend
    deploy:
      placement:
        constraints:
          - node.labels.govtool-test-stack == true
      restart_policy:
        delay: "30s"
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 300M